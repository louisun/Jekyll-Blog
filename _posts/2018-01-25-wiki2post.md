---
layout: post
title: wiki2post
toc: true
tags: ['工具']
cover: 'http://7xj74s.com1.z0.glb.clouddn.com/2018-01-29-23-54-00_r85.png'
---


<!-- 

time: 2018-01-25

cover: http://7xj74s.com1.z0.glb.clouddn.com/2018-01-29-23-54-00_r85.png

 -->





![](http://7xj74s.com1.z0.glb.clouddn.com/2018-01-25-22-52-14_r14.png)







`wiki2post` 是一个自动化文档同步、备份、部署工具，只支持`Python3`。





这只是我为解决自己需求的一个工具，并且分享一下思路。



Github 地址: [wiki2post](https://github.com/louisun/wiki2post)



<!-- more -->



**首要功能是生成满足静态博客需要的源`Markdown`文件，为什么有这种需求呢？**



先让我用大量篇幅解释一下我要解决的问题是什么。想跳过请直接查看使用方法部分。



## 解决的问题



解决问题的**核心想法**就是将**写作本身**和 **管理、备份、部署** 解藕，

说白了就是让你**意识不到静态博网站生器的存在**， 只要配置好了，安心写作就行，不用把文件改来改去移来移去，不用运行很多命令才能部署到网站上。



众所周知，手动管理笔记是一项麻烦的工作，文档一多要分门别类，还要考虑便捷快速地搜索查找，总不能一个一个文件夹依次打开吧？这还不算太麻烦，如果你有一个静态博客需要源文件，你还需要将原 wiki 大杂烩中的笔记一一拷贝至静态博客目录。如果这样还算好的话，静态博客所需的`Markdown`文件需要有一些标记，比如：



```text

---

layout: post

time: 2018-01-01

title: 标题

tags: ['java', '编程']

cover: 封面url

toc: true

---

```



你还要手动给每个文件加上类似的头部，如果写在原文件里，这个Header可不是注释，是会渲染出来的，很不美观，其它地方要用到此文件又要手动删掉 Header。Header中即使是默认选项也要手动打，title 也要自己填，文档多了总归是忙不过来。



如果这还算好，那么现在涉及到一个**笔记依赖问题**，你现在有**两份文档**，一份是源文件（在一个比较咋乱的笔记目录里，此目录还有很多草稿之类的笔记），一份是给静态博客使用的文件。假如以后要修改内容，应该修改哪份呢？要备份笔记，又要备份哪份呢？笔记一多，期间零零碎碎修改了好个版本，肯定会乱七八糟搞不清楚的。



有很多人为了解决此问题，大概会选择只保留一份笔记，老老实实手动填上 Header。然后另外弄一个Draft目录，等写完了再移动到POST目录里。可是这样你的笔记就分散了，并且还有可能带来两个版本的问题。



## 解决方案





我日常是用 `vscode` 管理我的笔记目录，如下：

![](http://7xj74s.com1.z0.glb.clouddn.com/2018-01-25-15-47-13_r15.png)



这样可以做到**方便搜索、浏览、修改**，而不需要文件夹反复进入退出查找。



如图本地有各种层次的文件夹，里面是源`Markdown`文件。



我的解决方案是只保留**源文件**一份，而静态博客如`Jekyll`或者`Hexo`所需的`_posts`目录中的文件由源文件生成，`Header`信息自动填写。



只需在源文件头部填写最简单的注释信息即可

```text

<!-- 

time: 2018-01-01

title: Java 函数式编程

cover: http://7xj74s.com1.z0.glb.clouddn.com/2018-01-24-11-06-42_r68.png

tags: Java, 函数式编程

-->

```



有人会说这不是和之前一样麻烦吗，还不是要写头部。的确，但是这样一是不会在 `HTML` 中渲染出来，信息是隐藏的，二是我其实做了很多的简化。最短的头部信息只需要时间`time`字段即可。不得不提醒一下：`vscode` 下`<!--  -->`注释可以直接`Ctrl` + `/`省去手打。



```text

<!-- 

time: 2018-01-10

-->

```

是的，其他必要信息如`title`, `tags` 都会自动生成。



以 `Jekyll` 为例， 我用的主题是：[H2O](https://github.com/louisun/Jekyll-Blog)，之前的头部信息的如下



```text

---

layout: post

time: 2018-01-01

title: 标题

tags: ['java', '编程']

cover: 封面url

toc: true

---

```



其中 layer 通常是`post`， toc 本来默认是`false`, 用注释都自动简化掉了。



## 关于备份 posts



另外，每次运行项目，都会将目标目录所有生成的`Markdown`文件先打包备份到`backup`目录里（保留最近10个备份），再将其清空重新生成。





## 使用方法



```bash

git clone git@github.com:louisun/wiki2post.git



cd wiki2post



# 用到了 pyyaml 和 termcolor

pip install -r requirements

```



### 本地生成演示



```bash

python main.py

```



<script src="https://asciinema.org/a/q0Ud0E7AZU792tlXqnqhv2uaj.js" id="asciicast-q0Ud0E7AZU792tlXqnqhv2uaj" async></script>





### 一键部署演示



其实不需要上面本地生成手动运行 Python，直接运行脚本集所有流程一体化



配置好`Deploy`文件夹下的两个 shell 脚本



**rsync_deploy.sh** 部署到服务器的，ssh 连接、服务器配置啥的需要你自己解决



```bash

#!/bin/sh

# -----------------------------------------------------------

# rsync_deploy.sh

# -----------------------------------------------------------



# Config Variables

localjekyll="/home/roadsheep/Jekyll-Blog"  # 本地jekyll根目录

remotewebroot="/var/www/louisun.me/jekyll" # 远程根目录

instancehost="www.louisun.me"              # 域名/ip

sshuser="root"                             # 主机用户

sshport="22"                               # ssh 端口

sshidentity="~/.ssh/id_rsa"                # 私钥路径

```



效果如下：



---



<script src="https://asciinema.org/a/sgQsiJRpzH0XukaaJISVQywJ5.js" id="asciicast-sgQsiJRpzH0XukaaJISVQywJ5" async></script>





**local_serve.sh** 是本地部署启动服务器，默认地址是`http://localhost:4000`





本地部署只需要配置 Jekyll 目录就行了

```bash

#!/bin/sh

# -----------------------------------------------------------

# local_serve.sh

# -----------------------------------------------------------



# Config Variables

localjekyll="/home/roadsheep/Jekyll-Blog"  # 本地jekyll根目录

```



效果如下：

<script src="https://asciinema.org/a/uFcOWzalmhAI5MuILOEOCj7s3.js" id="asciicast-uFcOWzalmhAI5MuILOEOCj7s3" async></script>



### 1. 将注释信息写入源文件头部

注释字段名：



- layout (不需要写，暂不支持更改，默认是 post，)

- **time** (必选，只有时间是必须要有的 2018-01-01 格式)

- title (可选，不填则扫描**一号标题**获取，和文件名无关)

- tags (可选，不填则通过扫描文件路径名获取, 逗号分隔)

- cover（可选，封面图 URL）

- toc (可选，默认 true , 可设置 false)

- hide (可选，默认 false,不想发布可设置 true)



请注意每个字段的格式：

```text

最简格式：

<!-- 

time: 2018-01-01

-->



最全格式:

<!-- 

time: 2018-01-01

title: wiki2post 

tags: Python, Markdown

cover: http://www.xxx.com/wiki2post.png

toc: false

hide: false

-->



<!-- 注：下面这些都是原文 -->



# 一号标题（最好写上吧！）



<!-- more -->



## 二号标题



## 二号标题

```



**说明：**



这个一号标题最好一定要有的，不指定 `title` 会扫描一号标题定为 `title`，生成的目标文件中一号标题是会自动删除的（因为有些网站会自动生成标题，不删除就会留2个大标题很难看）。如果没一号标题，一定要指定 `title` 字段，这是最后运行成功的希望。



还有源文件名和 `title` （也就是一号标题）其实没什么关系，源文件名随便起，`title` 对了就行，不过最好还是要一致。



我这个主题的日期信息不是写在 Header 的，是放目标文件名前面的，也就是说生成的文件名是这样的：



![](http://7xj74s.com1.z0.glb.clouddn.com/2018-01-25-16-22-52_r99.png)



但这个只要你在源文件中写了 `time` 注释，这些不用管了





至于`tags`，如果指定了就会按指定的 tag 列表来，如果没指定，根据路径名(父目录、子目录)生成，对于路径`/home/roadsheep/Blog/Java/spring`下的`.md`为后缀的文件，由于后面我们设置了 `WIKI_DIR` 参数为`/home/roadsheep/Blog`，tags 列表自动会设置为`Java, spring`





其他值得关注的是`hide`字段，其实这只是一个标志，如果设置成`true`了，原来发布的文件会被撤掉，但慌什么，源文件还在啊，随手把这行删了就又发布了。这是非常方便的一个功能。









### 2. 配置项目



编辑`config.yml`文件：



```yaml

# 源文档根目录

WIKI_DIR: "/home/roadsheep/Blog" 



# Jekyll 根目录

ROOT_DIR: "/home/roadsheep/Jekyll-Blog" 



# Jekyll 根目录下的目标目录

DEST_DIR: "_posts" 



# 可折叠目录， 具体含义请看 README.md

NARROW_DIR: "UNCOMMON" 



# WIKI_DIR 下应排除的目录列表

EXCLUDE_DIRS: 

  - "Hexo"

  - "Job"

  - "草稿"

  - "Draft"

  - "日语"

  - "外语"

  - ".git"

  - ".vscode"

```



**以上的变量我一一解释：**



我所有的笔记都在 Blog 目录下，`WIKI_DIR` 写上你自己文档的绝对路径



我的 Jekyll 根项目是 Jekyll-Blog，`ROOT_DIR` 写上静态网站项目的绝对路径



`DEST_DIR`是存放生成目标文件的地方，也就是Jekyll 目录下的`_posts`目录，静态网站生成器是从这个目录获取`Markdown`并生成`HTML`的



`NARROW_DIR`目录，就是有些不常用的目录都收纳在这个目录里面，比如我是“UNCOMMON"，子目录都是些不常用的笔记，我们根据路径生成 `tag` 列表会默认忽略这个目录的`tag`，但子目录的`tag`都是能扫描到的。 







![](http://7xj74s.com1.z0.glb.clouddn.com/2018-01-25-16-53-36_r66.png)



`EXCLUDE_DIRS`就是那些你想忽略的目录列表，按格式填写自己的列表就行